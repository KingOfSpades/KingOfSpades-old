<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Pod Affinity and Anti-affinity - Spreading out workloads" /><meta property="og:locale" content="en" /><meta name="description" content="I have written about using Taints and Tolerations to prevent pods from running on certain (tainted) nodes and there is some influence on scheduling that we can exert using Limits and Requests. But if we really want to control pod placement we have to look no further than Node/Pod Affinity and Anti-Affinity. This allows you to specify nodes that your pod can run on (Pod Affinity) and can be used to spread out your pods at runtime to different nodes using Anti-Affinity. Why? Because it’s great to have a container cluster, but if all your pods are landing on a single note your not gonna have a great (up)time. Let’s get started!" /><meta property="og:description" content="I have written about using Taints and Tolerations to prevent pods from running on certain (tainted) nodes and there is some influence on scheduling that we can exert using Limits and Requests. But if we really want to control pod placement we have to look no further than Node/Pod Affinity and Anti-Affinity. This allows you to specify nodes that your pod can run on (Pod Affinity) and can be used to spread out your pods at runtime to different nodes using Anti-Affinity. Why? Because it’s great to have a container cluster, but if all your pods are landing on a single note your not gonna have a great (up)time. Let’s get started!" /><link rel="canonical" href="https://kingofspades.github.io/posts/pod-affinity-and-anti-affinity/" /><meta property="og:url" content="https://kingofspades.github.io/posts/pod-affinity-and-anti-affinity/" /><meta property="og:site_name" content="Christian’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-06T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Pod Affinity and Anti-affinity - Spreading out workloads" /><meta name="twitter:site" content="@CABenstein" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-02-06T00:00:00+01:00","datePublished":"2022-02-06T00:00:00+01:00","description":"I have written about using Taints and Tolerations to prevent pods from running on certain (tainted) nodes and there is some influence on scheduling that we can exert using Limits and Requests. But if we really want to control pod placement we have to look no further than Node/Pod Affinity and Anti-Affinity. This allows you to specify nodes that your pod can run on (Pod Affinity) and can be used to spread out your pods at runtime to different nodes using Anti-Affinity. Why? Because it’s great to have a container cluster, but if all your pods are landing on a single note your not gonna have a great (up)time. Let’s get started!","headline":"Pod Affinity and Anti-affinity - Spreading out workloads","mainEntityOfPage":{"@type":"WebPage","@id":"https://kingofspades.github.io/posts/pod-affinity-and-anti-affinity/"},"url":"https://kingofspades.github.io/posts/pod-affinity-and-anti-affinity/"}</script><title>Pod Affinity and Anti-affinity - Spreading out workloads | Christian's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Christian's Blog"><meta name="application-name" content="Christian's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.updateMermaid(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/bio-photo.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Christian's Blog</a></div><div class="site-subtitle">Stories of /dev/null</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/ex280/" class="nav-link"> <i class="fa-fw fas fa-graduation-cap ml-xl-3 mr-xl-3 unloaded"></i> <span>EX280</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/KingOfSpades" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Pod Affinity and Anti-affinity - Spreading out workloads</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Pod Affinity and Anti-affinity - Spreading out workloads</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/KingOfSpades">Christian A. Benstein</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-02-06 00:00:00 +0100" data-toggle="tooltip" data-placement="bottom" title="Sun, Feb 6, 2022, 12:00 AM +0100" >Feb 6</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1379 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>I have written about using <a href="https://blog.benstein.nl/posts/tolerating-tolerations-openshift/">Taints and Tolerations</a> to prevent pods from running on certain (tainted) nodes and there is some influence on scheduling that we can exert using <a href="https://blog.benstein.nl/posts/quotas-limits-and-limit-ranges/">Limits and Requests</a>. But if we really want to control pod placement we have to look no further than Node/Pod Affinity and Anti-Affinity. This allows you to specify nodes that your pod can run on (Pod Affinity) and can be used to spread out your pods at runtime to different nodes using Anti-Affinity. Why? Because it’s great to have a container cluster, but if all your pods are landing on a single note your not gonna have a great (up)time. Let’s get started!</p><p>As always, these concepts apply to both Kubernetes and Openshift. We will try to do everything from the <code class="language-plaintext highlighter-rouge">oc</code> command line.</p><h1 id="understanding--affinity">Understanding Affinity</h1><p>Affinity means to have a natural liking to something. In Openshift it means that there is a connection (a preferred grouping) of resources. Naturally Anti-Affinity inverses this. With Affinity you can group workloads together on a single host or ensure that pods land on the same server. This can be useful if your workload gains performance by being scheduled together. The inverse is also true. By using Anti-Affinity rules we can make sure not all of our frontend pods are being run on the same node so that when it might go down or get busy our application pods won’t go down all at once.</p><p>Affinity is specified in your pod spec, <code class="language-plaintext highlighter-rouge">pod.spec.affinity</code>. Tip! Use <code class="language-plaintext highlighter-rouge">oc explain pod.spec.affinity</code> for some helpful info:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="s">$ oc explain pod.spec.affinity</span>
<span class="na">KIND</span><span class="pi">:</span>     <span class="s">Pod</span>
<span class="na">VERSION</span><span class="pi">:</span>  <span class="s">v1</span>

<span class="na">RESOURCE</span><span class="pi">:</span> <span class="s">affinity &lt;Object&gt;</span>

<span class="na">DESCRIPTION</span><span class="pi">:</span>
     <span class="s">If specified, the pod's scheduling constraints</span>

     <span class="s">Affinity is a group of affinity scheduling rules.</span>

<span class="na">FIELDS</span><span class="pi">:</span>
   <span class="s">nodeAffinity</span><span class="err">	</span><span class="s">&lt;Object&gt;</span>
     <span class="s">Describes node affinity scheduling rules for the pod.</span>

   <span class="s">podAffinity</span><span class="err">	</span><span class="s">&lt;Object&gt;</span>
     <span class="s">Describes pod affinity scheduling rules (e.g. co-locate this pod in the</span>
     <span class="s">same node, zone, etc. as some other pod(s)).</span>

   <span class="s">podAntiAffinity</span><span class="err">	</span><span class="s">&lt;Object&gt;</span>
     <span class="s">Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod</span>
     <span class="s">in the same node, zone, etc. as some other pod(s)).</span>
</pre></table></code></div></div><h2 id="node-affinity">Node Affinity<a href="#node-affinity"><i class="fas fa-hashtag"></i></a></h2></h2><p>With <code class="language-plaintext highlighter-rouge">nodeAffinity</code> we can ask the pod to be scheduled (or not to be scheduled) on a node with a certain label. This works a lot like a <code class="language-plaintext highlighter-rouge">toleration</code> (<code class="language-plaintext highlighter-rouge">pod.spec.tolerations</code>)</p><h2 id="pod-affinity">Pod Affinity<a href="#pod-affinity"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><code class="language-plaintext highlighter-rouge">podAffinity</code> is used to tell our pod to schedule our pod with other pods based on affinity rules<li><code class="language-plaintext highlighter-rouge">podAntiAffinity</code> enables us to separate pods based on affinity rules</ul><h2 id="required-fiels">Required fiels<a href="#required-fiels"><i class="fas fa-hashtag"></i></a></h2></h2><p>When using a Affinity rule you also need to specify the <code class="language-plaintext highlighter-rouge">topologyKey: kubernetes.io/hostname</code> in the <code class="language-plaintext highlighter-rouge">yaml</code>. Also, when using a Preferred rule you need to set a <code class="language-plaintext highlighter-rouge">weight</code> so that the scheduler knows (on a scale from 1-100) how strongly it should weigh the preference.</p><h2 id="why-not-taint">Why not taint?<a href="#why-not-taint"><i class="fas fa-hashtag"></i></a></h2></h2><p>At this point you might be asking, why not use a toleration or the nodeSelector found in the pods spec? This is a good question. Using these techniques gives us controll on where to place a pod but it does based on static information on the node. Using Affinity rules we can schedule dynamilcy based on where other pods are located.</p><h1 id="affinity-rules">Affinity Rules</h1><p>So, how does this work? Affinity Rules use matchExpressions based on <code class="language-plaintext highlighter-rouge">key=value</code> pairs to match. We will take the following <code class="language-plaintext highlighter-rouge">yaml</code> as an example:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">looking-for-a-green-pod</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">affinity</span><span class="pi">:</span>
    <span class="na">podAffinity</span><span class="pi">:</span> 
      <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">labelSelector</span><span class="pi">:</span>
          <span class="na">matchExpressions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">color</span>
            <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
            <span class="na">values</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">green</span>
            <span class="pi">-</span> <span class="s">darkgreen</span>
            <span class="pi">-</span> <span class="s">lightgreen</span>
        <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">looking-for-a-green-pod</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/ocpqe/hello-pod</span>
</pre></table></code></div></div><p>This will create a pod called <code class="language-plaintext highlighter-rouge">looking-for-a-green-pod</code> that looks for another pod that has the key <code class="language-plaintext highlighter-rouge">color</code> with one of three values <code class="language-plaintext highlighter-rouge">green</code>, <code class="language-plaintext highlighter-rouge">darkgreen</code> and <code class="language-plaintext highlighter-rouge">lightgreen</code>.</p><p>We could easily create a pod called <code class="language-plaintext highlighter-rouge">black-and-white</code> that just wont schedule on the same node as a pod with color defined using the following affinity rule:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="na">spec</span><span class="pi">:</span>
  <span class="na">affinity</span><span class="pi">:</span>
    <span class="na">podAffinity</span><span class="pi">:</span> 
      <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span> 
        <span class="na">labelSelector</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">matchExpressions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">color</span>
            <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
</pre></table></code></div></div><h2 id="understanding-operators">Understanding operators<a href="#understanding-operators"><i class="fas fa-hashtag"></i></a></h2></h2><p>The operators we can use are:</p><ul><li><strong>In</strong> Meaning one of the <code class="language-plaintext highlighter-rouge">values</code> in the <code class="language-plaintext highlighter-rouge">key</code> matches our <code class="language-plaintext highlighter-rouge">value</code><li><strong>NotIn</strong> Meaning the <code class="language-plaintext highlighter-rouge">value</code> is not in the <code class="language-plaintext highlighter-rouge">value</code> of the <code class="language-plaintext highlighter-rouge">key</code><li><strong>Exists</strong> Meaning the <code class="language-plaintext highlighter-rouge">value</code> exists in the <code class="language-plaintext highlighter-rouge">key</code><li><strong>DoesNotExist</strong> The <code class="language-plaintext highlighter-rouge">value</code> should not exist in the <code class="language-plaintext highlighter-rouge">key</code><li><strong>Lt</strong> Lesser then<li><strong>Gt</strong> Greater then</ul><h2 id="required-and-preferred">Required and Preferred<a href="#required-and-preferred"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can set up our Affinity rules in two modes, “Required” and “Preferred”. Let me explain:</p><ul><li><strong>Required</strong> Affinity rules have to be met before a pod is scheduled on a node<li><strong>Preferred</strong> Affinity rules are, well, preferred. We would like these rules to be met but we can be a bit more flexible</ul><h1 id="creating-pods-with-affinity-rules">Creating pods with Affinity rules</h1><p>Lets spin up two pods that want to be scheduled together, <code class="language-plaintext highlighter-rouge">green-pod</code> and <code class="language-plaintext highlighter-rouge">looking-for-a-green-pod</code>:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1"># green-pod.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">green-pod</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">color</span><span class="pi">:</span> <span class="s">green</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">green-pod</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/ocpqe/hello-pod</span>
</pre></table></code></div></div><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1"># looking-for-a-green-pod</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">looking-for-a-green-pod</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">affinity</span><span class="pi">:</span>
    <span class="na">podAffinity</span><span class="pi">:</span> 
      <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">labelSelector</span><span class="pi">:</span>
          <span class="na">matchExpressions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">color</span>
            <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
            <span class="na">values</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">green</span>
            <span class="pi">-</span> <span class="s">darkgreen</span>
            <span class="pi">-</span> <span class="s">lightgreen</span>
        <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">looking-for-a-green-pod</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/ocpqe/hello-pod</span>
</pre></table></code></div></div><p>You can save both these definitions to a <code class="language-plaintext highlighter-rouge">yaml</code> file and use <code class="language-plaintext highlighter-rouge">oc apply -f FILE</code> to create the. When this is done they should both be running on the same node:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span>oc get pods <span class="nt">-o</span> wide
NAME                      READY   STATUS    RESTARTS   AGE   IP             NODE                 NOMINATED NODE   READINESS GATES
green-pod                 1/1     Running   0          11m   10.217.0.98    crc-ktfxm-master-0   &lt;none&gt;           &lt;none&gt;
looking-for-a-green-pod   1/1     Running   0          64s   10.217.0.101   crc-ktfxm-master-0   &lt;none&gt;           &lt;none&gt;
</pre></table></code></div></div><p>Let’s create our pod that does not like any color:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1"># black-and-white.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">black-and-white</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">affinity</span><span class="pi">:</span>
    <span class="na">podAntiAffinity</span><span class="pi">:</span> 
      <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="na">labelSelector</span><span class="pi">:</span>
          <span class="na">matchExpressions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">color</span>
            <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
      <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">black-and-white</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/ocpqe/hello-pod</span>
</pre></table></code></div></div><p>Now when we have a look at our pods we will see that our newest one does not like to run with the other pods:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$ </span>oc get pods <span class="nt">-o</span> wide
NAME                      READY   STATUS    RESTARTS   AGE     IP             NODE                 NOMINATED NODE   READINESS GATES
black-and-white           0/1     Pending   0          14s     &lt;none&gt;         &lt;none&gt;               &lt;none&gt;           &lt;none&gt;
green-pod                 1/1     Running   0          16m     10.217.0.98    crc-ktfxm-master-0   &lt;none&gt;           &lt;none&gt;
looking-for-a-green-pod   1/1     Running   0          6m34s   10.217.0.101   crc-ktfxm-master-0   &lt;none&gt;           &lt;none&gt; 
</pre></table></code></div></div><p><strong>Note</strong> Because this is running on CRC which is single node cluster the pod will <em>not</em> start because there are no other nodes available.</p><p>And we can see the effect with <code class="language-plaintext highlighter-rouge">oc describe</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$ </span>oc describe pod black-and-white
....
Events:
  Type     Reason            Age                 From               Message
  <span class="nt">----</span>     <span class="nt">------</span>            <span class="nt">----</span>                <span class="nt">----</span>               <span class="nt">-------</span>
  Warning  FailedScheduling  36s <span class="o">(</span>x2 over 101s<span class="o">)</span>  default-scheduler  0/1 nodes are available: 1 node<span class="o">(</span>s<span class="o">)</span> didn<span class="s1">'t match pod anti-affinity rules.
</span></pre></table></code></div></div><p>Not lets change the pod from requiring the affinity rule from being met to a preffered rule. This is not as simple as swapping out <code class="language-plaintext highlighter-rouge">requiredDuringSchedulingIgnoredDuringExecution</code> because a preferred rules needs some extra information to work with, we will update our <code class="language-plaintext highlighter-rouge">yaml</code> to:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">black-and-white</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">affinity</span><span class="pi">:</span>
    <span class="na">podAffinity</span><span class="pi">:</span> 
      <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">weight</span><span class="pi">:</span> <span class="m">50</span>
        <span class="na">podAffinityTerm</span><span class="pi">:</span>
          <span class="na">labelSelector</span><span class="pi">:</span>
            <span class="na">matchExpressions</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">color</span>
              <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
          <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">black-and-white</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/ocpqe/hello-pod</span>
</pre></table></code></div></div><p>As we can see in the events now all pods are scheduled on the same node. Even the <code class="language-plaintext highlighter-rouge">black-and-white</code> pod because despite its preference there is simply no other node to run on.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>oc get events
LAST SEEN   TYPE      REASON             OBJECT                        MESSAGE
1m         Normal    Scheduled          pod/black-and-white           Successfully assigned all-together-now/black-and-white to crc-ktfxm-master-0 
</pre></table></code></div></div><h1 id="wrapping-up">Wrapping up</h1><p>Using Affinity Rules can help us dynamically select where our pods are scheduled based on node labels and other pods. This makes it easy to spread out a workload across a cluster or keep pods together for maximum performance.</p><p>I hope this post has helped you. Check out my other EX280 related content on my <a href="https://blog.benstein.nl/ex280/">EX280 page</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ex280/'>EX280</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/openshift/" class="post-tag no-text-decoration" >openshift</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/ex280/" class="post-tag no-text-decoration" >ex280</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Pod Affinity and Anti-affinity - Spreading out workloads - Christian's Blog&url=https://kingofspades.github.io/posts/pod-affinity-and-anti-affinity/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Pod Affinity and Anti-affinity - Spreading out workloads - Christian's Blog&u=https://kingofspades.github.io/posts/pod-affinity-and-anti-affinity/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Pod Affinity and Anti-affinity - Spreading out workloads - Christian's Blog&url=https://kingofspades.github.io/posts/pod-affinity-and-anti-affinity/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://kingofspades.github.io/posts/pod-affinity-and-anti-affinity/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/hey-for-loadtesting-http/">hey for load testing http applications</a><li><a href="/posts/building-the-montsinger-rebound-s/">Build-log: Montsinger Rebound-S</a><li><a href="/posts/lets-get-fuzzy/">Let's get fuzzys</a><li><a href="/posts/creating-a-ex280-page/">Creating my EX280 page on Jekyll</a><li><a href="/posts/troubelshooting-permissions-on-pods/">ServiceAccounts and SCCs - Running pods with more permission's</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ex280/">ex280</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/openshift/">openshift</a> <a class="post-tag" href="/tags/macos/">macos</a> <a class="post-tag" href="/tags/cli/">cli</a> <a class="post-tag" href="/tags/customization/">customization</a> <a class="post-tag" href="/tags/alfred/">alfred</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/controlling-pod-rollout-and-scaling/"><div class="card-body"> <em class="timeago small" date="2022-01-23 00:00:00 +0100" >Jan 23</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Scaling applications - Rollout, Scale and Auto-Scale Deployments</h3><div class="text-muted small"><p> This post is gonna be a bit bigger broader then what is requested on the EX280 exam objectives. In this post we will have a look at: Controlling roll-out of pods (manually rolling out or back a ...</p></div></div></a></div><div class="card"> <a href="/posts/quotas-limits-and-limit-ranges/"><div class="card-body"> <em class="timeago small" date="2022-01-29 00:00:00 +0100" >Jan 29</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quotas, limits and limit-ranges</h3><div class="text-muted small"><p> In this post we will be diving in to quotas and limits. Quotas and limits can be used to allocate, limit en reserve resources within your cluster for one or multiple namepaces and can limit the usa...</p></div></div></a></div><div class="card"> <a href="/posts/setting-up-auth-and-users/"><div class="card-body"> <em class="timeago small" date="2022-02-20 00:00:00 +0100" >Feb 20</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Manage users and policies, groups and permissions</h3><div class="text-muted small"><p> This blog will cover the “Manage users and policies” objective of the EX280 exam from RedHat. In this post we will: Configure the HTPasswd identity provider for authentication Create and dele...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/quotas-limits-and-limit-ranges/" class="btn btn-outline-primary" prompt="Older"><p>Quotas, limits and limit-ranges</p></a> <a href="/posts/switching-iterm-profile-on-job/" class="btn btn-outline-primary" prompt="Newer"><p>Switch iTerm profile when running Vim</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://kingofspades.github.io/posts/pod-affinity-and-anti-affinity/'; this.page.identifier = '/posts/pod-affinity-and-anti-affinity/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://https-blog-benstein-nl.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/KingOfSpades">Christian A. Benstein</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ex280/">ex280</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/openshift/">openshift</a> <a class="post-tag" href="/tags/macos/">macos</a> <a class="post-tag" href="/tags/cli/">cli</a> <a class="post-tag" href="/tags/customization/">customization</a> <a class="post-tag" href="/tags/alfred/">alfred</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-9VZBEPDENQ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9VZBEPDENQ'); }); </script>
